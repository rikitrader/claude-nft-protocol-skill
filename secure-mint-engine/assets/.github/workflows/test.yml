name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  actions: read

env:
  FOUNDRY_PROFILE: ci

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # FORGE TESTS (Unit + Invariant)
  # ═══════════════════════════════════════════════════════════════════════════
  forge-test:
    name: Forge Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # pin to SHA before production
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Cache Foundry build
        uses: actions/cache@v4 # pin to SHA before production
        with:
          path: |
            cache_forge
            out
          key: forge-build-${{ runner.os }}-${{ hashFiles('foundry.toml', 'contracts/**/*.sol', 'test/**/*.sol') }}
          restore-keys: |
            forge-build-${{ runner.os }}-

      - name: Build contracts
        run: forge build --sizes

      - name: Run unit tests
        run: forge test -vvv --no-match-contract Invariant
        env:
          FOUNDRY_PROFILE: ci

      - name: Run invariant tests
        run: forge test -vvv --match-contract Invariant
        env:
          FOUNDRY_PROFILE: ci

      - name: Generate coverage report
        run: forge coverage --report summary
        continue-on-error: true

      - name: Run gas snapshot
        run: forge snapshot --check || forge snapshot
        continue-on-error: true

      - name: Upload gas snapshot
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # pin to SHA before production
        with:
          name: gas-snapshot
          path: .gas-snapshot
        if: always()

  # ═══════════════════════════════════════════════════════════════════════════
  # PYTHON TESTS (pytest)
  # ═══════════════════════════════════════════════════════════════════════════
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python-engine
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # pin to SHA before production

      - name: Set up Python
        uses: actions/setup-python@v5 # pin to SHA before production
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: python-engine/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest
        run: pytest tests/ -v --tb=short

      - name: Run pytest with coverage
        run: pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml:coverage.xml
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # pin to SHA before production
        with:
          name: python-coverage
          path: python-engine/coverage.xml
        if: always()

  # ═══════════════════════════════════════════════════════════════════════════
  # ALL TESTS GATE
  # ═══════════════════════════════════════════════════════════════════════════
  all-tests:
    name: All Tests Pass
    runs-on: ubuntu-latest
    needs: [forge-test, python-test]
    steps:
      - name: All tests passed
        run: echo "All test suites passed successfully."

# =============================================================================
# MEMECOIN CI/CD PIPELINE - GITHUB ACTIONS
# =============================================================================
# Production-grade deployment pipeline for Solana Anchor programs
# =============================================================================

name: Memecoin Deploy Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet

env:
  SOLANA_VERSION: '1.18.26'
  ANCHOR_VERSION: '0.30.1'
  RUST_VERSION: 'stable'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # STAGE 1: Lint & Format Check
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check Anchor.toml
        run: |
          if [ ! -f "Anchor.toml" ]; then
            echo "‚ùå Anchor.toml not found"
            exit 1
          fi
          echo "‚úÖ Anchor.toml exists"

  # ===========================================================================
  # STAGE 2: Security Audit
  # ===========================================================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Check for common vulnerabilities
        run: |
          echo "üîç Checking for common Anchor vulnerabilities..."

          # Check for missing signer checks
          if grep -r "pub authority: AccountInfo" programs/; then
            echo "‚ö†Ô∏è WARNING: Found AccountInfo without Signer constraint"
          fi

          # Check for unchecked arithmetic
          if grep -rE "\+ [0-9]|[0-9] \+" programs/ | grep -v "checked_add"; then
            echo "‚ö†Ô∏è WARNING: Potential unchecked arithmetic found"
          fi

          # Check for missing owner checks
          if grep -r "#\[account\(mut\)\]" programs/ | grep -v "constraint"; then
            echo "‚ö†Ô∏è WARNING: Mutable accounts without constraints"
          fi

          echo "‚úÖ Basic security checks complete"

      - name: Verify no mint authority retention
        run: |
          echo "üîç Verifying mint authority handling..."

          # Check that mint authority is revoked
          if ! grep -r "set_authority.*None" programs/; then
            echo "‚ö†Ô∏è WARNING: No mint authority revocation found"
            echo "Ensure mint authority is set to None after minting"
          fi

          echo "‚úÖ Mint authority check complete"

  # ===========================================================================
  # STAGE 3: Build
  # ===========================================================================
  build:
    name: Build Programs
    runs-on: ubuntu-latest
    needs: [lint, security]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        uses: metaplex-foundation/actions/install-solana@v1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Setup Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}

      - name: Build programs
        run: anchor build

      - name: Verify build artifacts
        run: |
          for program in programs/*/; do
            name=$(basename $program)
            if [ ! -f "target/deploy/${name}.so" ]; then
              echo "‚ùå Build artifact missing: ${name}.so"
              exit 1
            fi
            echo "‚úÖ Built: ${name}.so"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: program-artifacts
          path: target/deploy/*.so

      - name: Generate IDL
        run: |
          anchor idl build
          mkdir -p idl
          cp target/idl/*.json idl/

      - name: Upload IDL
        uses: actions/upload-artifact@v4
        with:
          name: idl-artifacts
          path: idl/*.json

  # ===========================================================================
  # STAGE 4: Test (Localnet)
  # ===========================================================================
  test-localnet:
    name: Test (Localnet)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        uses: metaplex-foundation/actions/install-solana@v1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Setup Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run Anchor tests
        run: anchor test

      - name: Test coverage report
        run: |
          echo "üìä Test Results Summary"
          echo "======================"
          # Add coverage reporting if configured

  # ===========================================================================
  # STAGE 5: Test (Devnet)
  # ===========================================================================
  test-devnet:
    name: Test (Devnet)
    runs-on: ubuntu-latest
    needs: test-localnet
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Solana
        uses: metaplex-foundation/actions/install-solana@v1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Setup Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}

      - name: Configure devnet
        run: |
          solana config set --url devnet

          # Create test wallet
          solana-keygen new --no-bip39-passphrase -o /tmp/test-wallet.json

          # Airdrop SOL
          solana airdrop 2 /tmp/test-wallet.json --url devnet || true
          sleep 5
          solana airdrop 2 /tmp/test-wallet.json --url devnet || true

      - name: Deploy to devnet
        run: |
          anchor deploy --provider.cluster devnet

      - name: Run devnet integration tests
        run: |
          ANCHOR_PROVIDER_URL=https://api.devnet.solana.com \
          ANCHOR_WALLET=/tmp/test-wallet.json \
          npm run test:devnet

  # ===========================================================================
  # STAGE 6: Security Checklist Validation
  # ===========================================================================
  security-checklist:
    name: Pre-Deploy Security Checklist
    runs-on: ubuntu-latest
    needs: [test-localnet, test-devnet]
    if: github.event.inputs.network == 'mainnet'
    steps:
      - uses: actions/checkout@v4

      - name: Validate security requirements
        run: |
          echo "üîê PRE-DEPLOY SECURITY CHECKLIST"
          echo "================================"

          FAILED=0

          # Check 1: Mint authority
          echo ""
          echo "‚òê Mint authority handling..."
          if grep -r "set_authority.*MintTokens.*None" programs/; then
            echo "  ‚úÖ Mint authority revocation found"
          else
            echo "  ‚ùå FAIL: Mint authority revocation not found"
            FAILED=1
          fi

          # Check 2: Freeze authority
          echo ""
          echo "‚òê Freeze authority handling..."
          if grep -r "set_authority.*FreezeAccount.*None" programs/; then
            echo "  ‚úÖ Freeze authority revocation found"
          else
            echo "  ‚ö†Ô∏è WARNING: Freeze authority handling not explicit"
          fi

          # Check 3: Fixed supply
          echo ""
          echo "‚òê Fixed supply constraints..."
          if grep -r "AlreadyMinted" programs/; then
            echo "  ‚úÖ Minting restriction found"
          else
            echo "  ‚ùå FAIL: No minting restriction found"
            FAILED=1
          fi

          # Check 4: Multi-sig treasury
          echo ""
          echo "‚òê Treasury multi-sig..."
          if grep -r "threshold" programs/governance_multisig/ programs/treasury_vault/; then
            echo "  ‚úÖ Multi-sig threshold found"
          else
            echo "  ‚ùå FAIL: No multi-sig protection found"
            FAILED=1
          fi

          # Check 5: Emergency controls
          echo ""
          echo "‚òê Emergency controls..."
          if grep -r "MAX_PAUSE_DURATION" programs/; then
            echo "  ‚úÖ Time-limited pause found"
          else
            echo "  ‚ö†Ô∏è WARNING: Emergency controls may not be time-limited"
          fi

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå SECURITY CHECKLIST FAILED"
            echo "Fix issues before mainnet deployment"
            exit 1
          fi

          echo "‚úÖ SECURITY CHECKLIST PASSED"

  # ===========================================================================
  # STAGE 7: Manual Approval Gate
  # ===========================================================================
  approval-gate:
    name: Mainnet Approval
    runs-on: ubuntu-latest
    needs: security-checklist
    if: github.event.inputs.network == 'mainnet'
    environment:
      name: mainnet
      url: https://solscan.io
    steps:
      - name: Approval received
        run: |
          echo "‚úÖ Manual approval received for mainnet deployment"
          echo "Deployer: ${{ github.actor }}"
          echo "Time: $(date -u)"

  # ===========================================================================
  # STAGE 8: Mainnet Deploy
  # ===========================================================================
  deploy-mainnet:
    name: Deploy to Mainnet
    runs-on: ubuntu-latest
    needs: approval-gate
    if: github.event.inputs.network == 'mainnet'
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: program-artifacts
          path: target/deploy/

      - name: Setup Solana
        uses: metaplex-foundation/actions/install-solana@v1
        with:
          version: ${{ env.SOLANA_VERSION }}

      - name: Configure mainnet
        run: |
          solana config set --url mainnet-beta

      - name: Deploy programs
        env:
          DEPLOY_KEYPAIR: ${{ secrets.DEPLOY_KEYPAIR }}
        run: |
          # Write keypair securely with restricted permissions
          umask 077
          echo "$DEPLOY_KEYPAIR" > /tmp/deploy-wallet.json
          chmod 600 /tmp/deploy-wallet.json

          echo "üöÄ Deploying to Mainnet..."

          # Deploy specific programs with known program IDs
          # DO NOT blindly loop over all .so files
          PROGRAMS=("token_mint" "burn_controller" "treasury_vault" "governance_multisig" "emergency_pause")

          for name in "${PROGRAMS[@]}"; do
            program="target/deploy/${name}.so"
            if [ ! -f "$program" ]; then
              echo "‚ùå Missing program artifact: $program"
              exit 1
            fi

            echo "Deploying $name..."
            solana program deploy "$program" \
              --keypair /tmp/deploy-wallet.json \
              --url mainnet-beta

            echo "‚úÖ $name deployed"
          done

      - name: Record deployment
        run: |
          echo "üìù DEPLOYMENT RECORD"
          echo "==================="
          echo "Network: mainnet-beta"
          echo "Commit: ${{ github.sha }}"
          echo "Deployer: ${{ github.actor }}"
          echo "Time: $(date -u)"
          echo ""
          echo "Program IDs:"
          solana program show --programs --keypair /tmp/deploy-wallet.json

      - name: Cleanup
        if: always()
        run: |
          # Securely overwrite before removing
          dd if=/dev/urandom of=/tmp/deploy-wallet.json bs=1024 count=1 2>/dev/null || true
          rm -f /tmp/deploy-wallet.json

  # ===========================================================================
  # STAGE 9: Post-Deploy Verification
  # ===========================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-mainnet
    if: github.event.inputs.network == 'mainnet'
    steps:
      - name: Verify programs
        run: |
          echo "üîç POST-DEPLOY VERIFICATION"
          echo "==========================="

          # Add program ID verification
          # Add on-chain state verification

          echo "‚úÖ Deployment verified"

      - name: Notify success
        run: |
          echo "üéâ MAINNET DEPLOYMENT SUCCESSFUL"
          echo ""
          echo "Next steps:"
          echo "1. Verify programs on Solscan"
          echo "2. Test transactions manually"
          echo "3. Create liquidity pool"
          echo "4. Lock/burn LP tokens"
          echo "5. Announce launch"
